<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OOTD â€“ Your Closet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #f6f3ed;
      --bg-card: #ffffff;
      --accent: #c6b49f;
      --accent-soft: rgba(198, 180, 159, 0.35);
      --text-main: #2b2a28;
      --text-muted: #7b746a;
      --border-subtle: rgba(0, 0, 0, 0.08);
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.06);
    }

    body.dark {
      --bg-main: #111111;
      --bg-card: #181818;
      --accent: #c6b49f;
      --accent-soft: rgba(198, 180, 159, 0.45);
      --text-main: #f8f5ef;
      --text-muted: #b4aca1;
      --border-subtle: rgba(255,255,255,0.08);
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.6);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
      transition: background 0.25s ease, color 0.25s ease;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid var(--border-subtle);
      padding: 12px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.25s ease, border-color 0.25s ease;
    }
    body.dark header {
      background: rgba(15,15,15,0.92);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, #fdfbf7 0, #e9e0d3 65%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      position: relative;
      overflow: hidden;
    }
    body.dark .logo-mark {
      background: radial-gradient(circle at top left, #26231f 0, #14110e 65%);
    }

    .logo-mark::before {
      content: "";
      position: absolute;
      inset: 22%;
      border-radius: 14px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .logo-text-main {
      font-weight: 600;
      font-size: 18px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .logo-text-sub {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(255,255,255,0.9);
      font-size: 12px;
      color: var(--text-muted);
    }
    body.dark .pill {
      background: rgba(18,18,18,0.9);
    }

    .pill strong {
      color: var(--text-main);
    }

    .icon-btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      padding: 5px 10px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn:hover {
      background: rgba(0,0,0,0.04);
    }
    body.dark .icon-btn:hover {
      background: rgba(255,255,255,0.05);
    }

    .logout-btn {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }
    .logout-btn:hover {
      background: rgba(255,255,255,0.12);
    }

    main {
      max-width: 1100px;
      margin: 22px auto 32px;
      padding: 0 16px;
    }

    .tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      background: rgba(255,255,255,0.7);
      margin-bottom: 18px;
    }
    body.dark .tabs {
      background: rgba(18,18,18,0.9);
    }

    .tab {
      padding: 7px 14px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }

    .tab.active {
      background: var(--bg-card);
      color: var(--text-main);
      font-weight: 500;
    }

    .section {
      display: none;
    }
    .section.active {
      display: block;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 16px 16px 18px;
      margin-bottom: 18px;
      position: relative;
      overflow: hidden;
      transform: translateY(0);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.25s ease, border-color 0.25s ease;
    }

    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(0,0,0,0.08);
    }

    h2 {
      margin: 0 0 4px;
      font-size: 18px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 500;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 13px;
      margin-bottom: 10px;
    }

    .field-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    input,
    select,
    textarea,
    button {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: rgba(255,255,255,0.9);
      color: var(--text-main);
      font-size: 14px;
      padding: 9px 10px;
      outline: none;
      transition: border 0.18s ease, box-shadow 0.18s ease, background 0.2s ease, transform 0.12s ease;
    }
    body.dark input,
    body.dark select,
    body.dark textarea {
      background: #141414;
    }

    input::placeholder,
    textarea::placeholder {
      color: #b4aca1;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(198,180,159,0.3);
      background: #fdfaf5;
    }
    body.dark input:focus,
    body.dark select:focus,
    body.dark textarea:focus {
      background: #181818;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    button {
      background: linear-gradient(135deg, #e1d4c3, #d0bfa9);
      border: 1px solid rgba(0,0,0,0.05);
      font-weight: 500;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-size: 11px;
      margin-top: 10px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
    }
    body.dark button {
      background: linear-gradient(135deg, #3a332b, #2a2520);
      border-color: rgba(255,255,255,0.04);
      box-shadow: 0 10px 24px rgba(0,0,0,0.7);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(0,0,0,0.1);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    .btn-secondary {
      background: transparent;
      border-style: dashed;
      box-shadow: none;
      text-transform: none;
      letter-spacing: 0.05em;
      font-size: 12px;
    }
    body.dark .btn-secondary {
      background: #151515;
    }

    .two-col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }

    .closet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .item-card {
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #fdfcf9;
      padding: 7px;
      position: relative;
      cursor: grab;
      transition: transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease;
    }
    body.dark .item-card {
      background: #181715;
    }

    .item-card:active {
      cursor: grabbing;
    }

    .item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.14);
      border-color: rgba(0,0,0,0.14);
    }

    .item-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 9px;
      background: #e5ddd1;
    }

    .item-info {
      margin-top: 5px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .item-info strong {
      display: block;
      color: var(--text-main);
      font-size: 12px;
    }

    .badge {
      position: absolute;
      top: 6px;
      left: 6px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(0,0,0,0.06);
      color: var(--text-muted);
    }

    .builder-dropzone {
      margin-top: 10px;
      min-height: 130px;
      border-radius: 14px;
      border: 1px dashed rgba(0,0,0,0.16);
      background: rgba(250,247,242,0.9);
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    body.dark .builder-dropzone {
      background: rgba(20,20,20,0.9);
      border-color: rgba(255,255,255,0.14);
    }

    .builder-dropzone.is-over {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(198,180,159,0.35);
      background: #f4ece1;
    }
    body.dark .builder-dropzone.is-over {
      background: #201c18;
    }

    .builder-item {
      width: 70px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
      background: #fff;
      font-size: 9px;
      text-align: center;
    }
    body.dark .builder-item {
      background: #181818;
    }

    .builder-item img {
      width: 100%;
      height: 90px;
      object-fit: cover;
      display: block;
    }

    .builder-item span {
      display: block;
      padding: 3px 4px 5px;
      color: var(--text-muted);
    }

    .outfit-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .outfit-slot {
      width: 90px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #fdfcf9;
      font-size: 10px;
      overflow: hidden;
      text-align: center;
    }
    body.dark .outfit-slot {
      background: #181715;
    }

    .outfit-slot img {
      width: 100%;
      height: 110px;
      object-fit: cover;
      display: block;
    }

    .outfit-slot span {
      display: block;
      padding: 3px 6px 5px;
      color: var(--text-muted);
    }

    .outfit-footer {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .saved-outfits {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
    }

    .saved-card {
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #f5f1ea;
      padding: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    body.dark .saved-card {
      background: #211d18;
    }

    .saved-thumbs {
      display: flex;
      gap: 4px;
    }

    .saved-thumbs img {
      width: 40px;
      height: 40px;
      border-radius: 9px;
      object-fit: cover;
      border: 1px solid rgba(0,0,0,0.08);
      background: #e5ddd1;
    }

    .saved-meta {
      flex: 1;
      font-size: 11px;
      color: var(--text-muted);
    }

    .saved-meta strong {
      display: block;
      color: var(--text-main);
      font-size: 12px;
      margin-bottom: 2px;
      font-weight: 500;
    }

    .tiny-button {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }

    .tiny-button:hover {
      border-color: var(--accent-soft);
      color: var(--text-main);
      background: rgba(255,255,255,0.7);
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-top: 6px;
      color: var(--text-muted);
    }

    @media (max-width: 780px) {
      header {
        flex-wrap: wrap;
        gap: 10px;
      }
      .header-right {
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo-mark"></div>
    <div>
      <div class="logo-text-main">OOTD</div>
      <div class="logo-text-sub">AI closet stylist</div>
    </div>
  </div>
  <div class="header-right">
    <div class="pill">
      <strong id="userNameLabel">User</strong>
      <span>closet</span>
    </div>
    <button id="themeToggle" class="icon-btn" type="button">
      <span id="themeIcon">ðŸŒž</span><span>Mode</span>
    </button>
    <button id="logoutBtn" class="logout-btn" type="button">Logout</button>
  </div>
</header>

<main>
  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-target="closetSection">Closet</button>
    <button class="tab" data-target="outfitsSection">Outfits</button>
    <button class="tab" data-target="statsSection">Stats</button>
  </div>

  <!-- CLOSET SECTION -->
  <section id="closetSection" class="section active">
    <div class="card">
      <h2>Add clothing</h2>
      <div class="subtitle">
        Photograph pieces, tag them once. OOTD will keep them tied to your account on this device.
      </div>

      <div class="field-label">Photo</div>
      <input id="imageInput" type="file" accept="image/*" capture="environment" />

      <div class="two-col">
        <div>
          <div class="field-label">Category</div>
          <select id="category">
            <option value="">Select</option>
            <option value="Top">Top</option>
            <option value="Bottom">Bottom</option>
            <option value="Shoes">Shoes</option>
            <option value="Jacket">Jacket</option>
            <option value="Dress">Dress</option>
          </select>
        </div>
        <div>
          <div class="field-label">Style</div>
          <select id="style">
            <option value="">Select</option>
            <option value="Casual">Casual</option>
            <option value="Formal">Formal</option>
            <option value="Streetwear">Streetwear</option>
            <option value="Sporty">Sporty</option>
          </select>
        </div>
      </div>

      <div class="two-col">
        <div>
          <div class="field-label">Color</div>
          <input id="color" type="text" placeholder="e.g., black, white, beige" />
        </div>
        <div>
          <div class="field-label">Season warmth</div>
          <select id="warmth">
            <option value="">Any</option>
            <option value="Light">Light / summer</option>
            <option value="Medium">Medium</option>
            <option value="Warm">Warm / winter</option>
          </select>
        </div>
      </div>

      <button id="addItemBtn" type="button">+ Add to closet</button>
    </div>

    <div class="card">
      <h2>Your closet</h2>
      <div class="subtitle">Drag pieces into the builder on the Outfits tab to create custom looks.</div>
      <div id="closetGrid" class="closet-grid"></div>
    </div>
  </section>

  <!-- OUTFITS SECTION -->
  <section id="outfitsSection" class="section">
    <div class="card">
      <h2>AI outfit generator</h2>
      <div class="subtitle">Describe the vibe and weather. OOTD suggests a look from your closet.</div>

      <div class="field-label">Prompt</div>
      <textarea id="prompt" placeholder="e.g., comfy winter outfit for class with my white sneakers"></textarea>

      <div class="two-col">
        <div>
          <div class="field-label">Vibe</div>
          <select id="vibeSelect">
            <option value="">Auto</option>
            <option value="Casual">Casual</option>
            <option value="Formal">Formal</option>
            <option value="Streetwear">Streetwear</option>
            <option value="Sporty">Sporty</option>
            <option value="Date">Date night</option>
            <option value="Work">Work / smart casual</option>
          </select>
        </div>
        <div>
          <div class="field-label">Weather</div>
          <select id="weatherSelect">
            <option value="">Any</option>
            <option value="Cold">Cold / winter</option>
            <option value="Warm">Warm / summer</option>
            <option value="Rainy">Rainy</option>
          </select>
        </div>
      </div>

      <div class="field-label">Must include</div>
      <input id="mustIncludeInput" type="text" placeholder="e.g., use black jeans, include white sneakers" />

      <button id="generateOutfitBtn" type="button">Generate outfit</button>

      <div class="outfit-preview" id="outfitPreviewArea"></div>
      <div class="outfit-footer" id="outfitFooter"></div>
    </div>

    <div class="card">
      <h2>Outfit builder</h2>
      <div class="subtitle">Drag items from the closet into this space, then save as a named look.</div>
      <div id="builderDropzone" class="builder-dropzone">
        <span class="subtitle" style="margin:0;font-size:11px;">Drop pieces here to build a fit.</span>
      </div>
      <button id="saveBuilderOutfitBtn" class="btn-secondary" type="button">Save this outfit</button>
    </div>

    <div class="card">
      <h2>Saved outfits</h2>
      <div class="subtitle">Tap load to refill the builder with that look.</div>
      <div id="savedOutfitsContainer" class="saved-outfits"></div>
    </div>
  </section>

  <!-- STATS SECTION -->
  <section id="statsSection" class="section">
    <div class="card">
      <h2>Wardrobe stats</h2>
      <div class="subtitle">A quick snapshot of what lives in your digital closet.</div>

      <div id="statsContent"></div>
    </div>
  </section>
</main>

<script>
  const USERS_KEY = "ootd_users";
  const CURRENT_USER_KEY = "ootd_current_user";
  const THEME_KEY = "ootd_theme";

  let users = [];
  let currentUserId = null;
  let currentUser = null;
  let builderItems = [];

  function loadUsers() {
    try {
      return JSON.parse(localStorage.getItem(USERS_KEY)) || [];
    } catch {
      return [];
    }
  }

  function saveUsers() {
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  }

  function saveCurrentUser() {
    const idx = users.findIndex(u => u.id == currentUser.id);
    if (idx !== -1) {
      users[idx] = currentUser;
      saveUsers();
    }
  }

  function isNeutral(color) {
    if (!color) return false;
    const c = color.toLowerCase();
    return ["black","white","grey","gray","beige","cream","navy","denim","brown","tan","khaki"]
      .some(n => c.includes(n));
  }

  function warmScore(warmth) {
    if (!warmth) return 1;
    if (warmth === "Light") return 0.4;
    if (warmth === "Medium") return 1;
    if (warmth === "Warm") return 1.6;
    return 1;
  }

  function uuid() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
  }

  // THEME
  function applyTheme() {
    const theme = localStorage.getItem(THEME_KEY) || "light";
    if (theme === "dark") {
      document.body.classList.add("dark");
      document.getElementById("themeIcon").textContent = "ðŸŒ™";
    } else {
      document.body.classList.remove("dark");
      document.getElementById("themeIcon").textContent = "ðŸŒž";
    }
  }

  document.getElementById("themeToggle").addEventListener("click", () => {
    const current = localStorage.getItem(THEME_KEY) || "light";
    const next = current === "light" ? "dark" : "light";
    localStorage.setItem(THEME_KEY, next);
    applyTheme();
  });

  // NAV TABS
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");

      const target = tab.dataset.target;
      document.querySelectorAll(".section").forEach(s => {
        s.classList.toggle("active", s.id === target);
      });
    });
  });

  // LOGOUT
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem(CURRENT_USER_KEY);
    window.location.href = "index.html";
  });

  // CLOSET RENDER
  function renderCloset() {
    const grid = document.getElementById("closetGrid");
    const closet = currentUser.closet || [];
    grid.innerHTML = "";

    if (!closet.length) {
      grid.innerHTML = "<div class='subtitle'>No items yet. Add a few pieces to get started.</div>";
      return;
    }

    closet.forEach(item => {
      const card = document.createElement("div");
      card.className = "item-card";
      card.draggable = true;
      card.dataset.id = item.id;

      const img = document.createElement("img");
      img.src = item.image;
      img.alt = item.category;

      const info = document.createElement("div");
      info.className = "item-info";
      info.innerHTML = `
        <strong>${item.category}</strong>
        <span>${item.color || "No color"}</span><br/>
        <span>${item.style || "No style"} â€¢ ${item.warmth || "Any"}</span>
      `;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = item.isNeutral ? "Neutral" : "Accent";

      card.appendChild(img);
      card.appendChild(info);
      card.appendChild(badge);

      card.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", item.id);
      });

      grid.appendChild(card);
    });
  }

  // BUILDER RENDER
  function renderBuilder() {
    const zone = document.getElementById("builderDropzone");
    zone.innerHTML = "";
    if (!builderItems.length) {
      const span = document.createElement("span");
      span.className = "subtitle";
      span.style.fontSize = "11px";
      span.textContent = "Drop pieces here to build a fit.";
      zone.appendChild(span);
      return;
    }

    builderItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "builder-item";
      div.innerHTML = `
        <img src="${item.image}" alt="${item.category}"/>
        <span>${item.category}</span>
      `;
      zone.appendChild(div);
    });
  }

  function setupDropzone() {
    const zone = document.getElementById("builderDropzone");
    zone.addEventListener("dragover", e => {
      e.preventDefault();
      zone.classList.add("is-over");
    });
    zone.addEventListener("dragleave", () => {
      zone.classList.remove("is-over");
    });
    zone.addEventListener("drop", e => {
      e.preventDefault();
      zone.classList.remove("is-over");
      const id = e.dataTransfer.getData("text/plain");
      const item = (currentUser.closet || []).find(i => i.id === id);
      if (!item) return;
      if (!builderItems.some(b => b.id === id)) {
        builderItems.push(item);
        renderBuilder();
      }
    });
  }

  // ADD ITEM
  document.getElementById("addItemBtn").addEventListener("click", () => {
    const file = document.getElementById("imageInput").files[0];
    const category = document.getElementById("category").value;
    const style = document.getElementById("style").value;
    const color = document.getElementById("color").value.trim();
    const warmth = document.getElementById("warmth").value;

    if (!file || !category || !style || !color) {
      alert("Please fill image, category, style, and color.");
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      const item = {
        id: uuid(),
        image: e.target.result,
        category,
        style,
        color,
        warmth,
        isNeutral: isNeutral(color)
      };
      currentUser.closet = currentUser.closet || [];
      currentUser.closet.push(item);
      saveCurrentUser();
      renderCloset();
      renderStats();
      document.getElementById("imageInput").value = "";
      document.getElementById("color").value = "";
      document.getElementById("category").value = "";
      document.getElementById("style").value = "";
      document.getElementById("warmth").value = "";
    };
    reader.readAsDataURL(file);
  });

  // ANALYSE PROMPT (fake AI brain)
  function analyzePrompt(prompt, vibeSelect, weatherSelect, mustIncludeText) {
    const lower = (prompt || "").toLowerCase();
    const vibe = vibeSelect || (
      lower.includes("formal") ? "Formal" :
      lower.includes("street") ? "Streetwear" :
      lower.includes("sport") || lower.includes("gym") ? "Sporty" :
      lower.includes("date") ? "Date" :
      lower.includes("work") || lower.includes("office") ? "Work" :
      "Casual"
    );

    let weather = weatherSelect || "";
    if (!weather) {
      if (lower.includes("winter") || lower.includes("cold")) weather = "Cold";
      else if (lower.includes("summer") || lower.includes("hot")) weather = "Warm";
      else if (lower.includes("rain") || lower.includes("rainy")) weather = "Rainy";
    }

    const includeHints = (mustIncludeText || "").toLowerCase();
    return { vibe, weather, includeHints };
  }

  // PICK OUTFIT
  function pickOutfit(context) {
    const closet = currentUser.closet || [];
    if (!closet.length) return [];

    const styleMap = {
      Casual: ["Casual","Streetwear","Sporty"],
      Formal: ["Formal"],
      Streetwear: ["Streetwear","Casual"],
      Sporty: ["Sporty","Casual"],
      Date: ["Casual","Formal","Streetwear"],
      Work: ["Formal","Casual"]
    };

    const allowedStyles = styleMap[context.vibe] || ["Casual","Streetwear","Sporty","Formal"];

    let filtered = closet.filter(i => allowedStyles.includes(i.style));

    if (context.weather === "Cold") {
      filtered = filtered.filter(i => warmScore(i.warmth) >= 1 || i.category === "Jacket");
    } else if (context.weather === "Warm") {
      filtered = filtered.filter(i => warmScore(i.warmth) <= 1.1);
    } else if (context.weather === "Rainy") {
      filtered = filtered.filter(i => i.category !== "Dress" || warmScore(i.warmth) >= 1);
    }

    if (!filtered.length) filtered = [...closet];

    if (context.includeHints) {
      const hint = context.includeHints;
      filtered = filtered.sort((a,b) => {
        const score = item => {
          let s = 0;
          if (hint.includes("white") && item.color.toLowerCase().includes("white")) s++;
          if (hint.includes("black") && item.color.toLowerCase().includes("black")) s++;
          if (hint.includes("jean") && item.category === "Bottom") s++;
          if (hint.includes("sneaker") && item.category === "Shoes") s++;
          return s;
        };
        return score(b) - score(a);
      });
    }

    const byCategory = {
      Top: filtered.filter(i => i.category === "Top"),
      Bottom: filtered.filter(i => i.category === "Bottom"),
      Shoes: filtered.filter(i => i.category === "Shoes"),
      Jacket: filtered.filter(i => i.category === "Jacket"),
      Dress: filtered.filter(i => i.category === "Dress")
    };

    function pickRandom(arr) {
      if (!arr.length) return null;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    let outfit = [];
    const wantDress = (context.vibe === "Date" || context.vibe === "Formal") && byCategory.Dress.length;

    if (wantDress) {
      const dress = pickRandom(byCategory.Dress);
      if (dress) outfit.push(dress);
    } else {
      const top = pickRandom(byCategory.Top);
      const bottom = pickRandom(byCategory.Bottom);
      if (top) outfit.push(top);
      if (bottom) outfit.push(bottom);
    }

    let shoes = pickRandom(byCategory.Shoes);
    if (!shoes && closet.find(i => i.category === "Shoes")) {
      shoes = closet.find(i => i.category === "Shoes");
    }
    if (shoes) outfit.push(shoes);

    if (context.weather === "Cold") {
      const jacket = pickRandom(byCategory.Jacket);
      if (jacket) outfit.push(jacket);
    }

    const accents = outfit.filter(i => !i.isNeutral);
    if (accents.length > 1) {
      const keep = accents[0];
      outfit = outfit.map(item => {
        if (!item.isNeutral && item !== keep) {
          const neutralSameCat = closet.filter(
            i => i.category === item.category && i.isNeutral
          );
          return neutralSameCat[0] || item;
        }
        return item;
      });
    }

    return outfit;
  }

  function renderGeneratedOutfit(outfit, context) {
    const area = document.getElementById("outfitPreviewArea");
    const footer = document.getElementById("outfitFooter");
    area.innerHTML = "";
    footer.textContent = "";

    if (!outfit.length) {
      footer.textContent = "No outfit found. Try adding more clothes or loosening the filters.";
      return;
    }

    outfit.forEach(item => {
      const slot = document.createElement("div");
      slot.className = "outfit-slot";
      slot.innerHTML = `
        <img src="${item.image}" alt="${item.category}" />
        <span>${item.category} Â· ${item.color}</span>
      `;
      area.appendChild(slot);
    });

    const vibeLabel = context.vibe || "Casual";
    const weatherLabel = context.weather || "Any";

    footer.innerHTML = `
      Suggesting a <strong>${vibeLabel.toLowerCase()}</strong> outfit for <strong>${weatherLabel.toLowerCase()}</strong> conditions.
      Neutrals are prioritised so it matches easily with your wardrobe.
    `;
  }

  document.getElementById("generateOutfitBtn").addEventListener("click", () => {
    const prompt = document.getElementById("prompt").value;
    const vibeSel = document.getElementById("vibeSelect").value;
    const weatherSel = document.getElementById("weatherSelect").value;
    const mustInclude = document.getElementById("mustIncludeInput").value;

    const ctx = analyzePrompt(prompt, vibeSel, weatherSel, mustInclude);
    const outfit = pickOutfit(ctx);
    renderGeneratedOutfit(outfit, ctx);

    builderItems = outfit.slice();
    renderBuilder();
  });

  // SAVE BUILDER OUTFIT
  document.getElementById("saveBuilderOutfitBtn").addEventListener("click", () => {
    if (!builderItems.length) {
      alert("Drag some pieces into the builder first.");
      return;
    }
    const name = prompt("Name this outfit (e.g., Cozy winter fit):");
    if (!name) return;

    const outfit = {
      id: uuid(),
      name,
      createdAt: new Date().toISOString(),
      itemIds: builderItems.map(i => i.id)
    };

    currentUser.outfits = currentUser.outfits || [];
    currentUser.outfits.unshift(outfit);
    saveCurrentUser();
    renderSavedOutfits();
    renderStats();
  });

  function renderSavedOutfits() {
    const container = document.getElementById("savedOutfitsContainer");
    const outfits = currentUser.outfits || [];
    const closet = currentUser.closet || [];

    container.innerHTML = "";
    if (!outfits.length) {
      container.innerHTML = "<div class='subtitle'>No saved outfits yet.</div>";
      return;
    }

    outfits.forEach(o => {
      const div = document.createElement("div");
      div.className = "saved-card";

      const thumbs = document.createElement("div");
      thumbs.className = "saved-thumbs";

      const items = o.itemIds.map(id => closet.find(i => i.id === id)).filter(Boolean).slice(0,4);
      if (items.length) {
        items.forEach(it => {
          const img = document.createElement("img");
          img.src = it.image;
          img.alt = it.category;
          thumbs.appendChild(img);
        });
      } else {
        thumbs.innerHTML = "<div class='subtitle' style='font-size:10px;'>Items missing</div>";
      }

      const meta = document.createElement("div");
      meta.className = "saved-meta";
      const date = new Date(o.createdAt);
      meta.innerHTML = `
        <strong>${o.name}</strong>
        <span>${items.length} pieces Â· ${date.toLocaleDateString()}</span>
      `;

      const actions = document.createElement("div");
      const loadBtn = document.createElement("button");
      loadBtn.type = "button";
      loadBtn.className = "tiny-button";
      loadBtn.textContent = "Load";
      loadBtn.addEventListener("click", () => {
        builderItems = o.itemIds.map(id => closet.find(i => i.id === id)).filter(Boolean);
        renderBuilder();
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "tiny-button";
      delBtn.style.marginLeft = "4px";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", () => {
        if (confirm("Delete this outfit?")) {
          currentUser.outfits = outfits.filter(x => x.id !== o.id);
          saveCurrentUser();
          renderSavedOutfits();
          renderStats();
        }
      });

      actions.appendChild(loadBtn);
      actions.appendChild(delBtn);

      div.appendChild(thumbs);
      div.appendChild(meta);
      div.appendChild(actions);
      container.appendChild(div);
    });
  }

  // STATS
  function renderStats() {
    const statsDiv = document.getElementById("statsContent");
    const closet = currentUser.closet || [];
    const outfits = currentUser.outfits || [];

    if (!closet.length) {
      statsDiv.innerHTML = "<div class='subtitle'>Add some items to see stats.</div>";
      return;
    }

    const counts = {Top:0, Bottom:0, Shoes:0, Jacket:0, Dress:0};
    const colorCount = {};

    closet.forEach(i => {
      if (counts[i.category] != null) counts[i.category]++;
      const c = (i.color || "").toLowerCase();
      if (!c) return;
      colorCount[c] = (colorCount[c] || 0) + 1;
    });

    let favColor = "";
    let favCount = 0;
    Object.entries(colorCount).forEach(([c, count]) => {
      if (count > favCount) {
        favColor = c;
        favCount = count;
      }
    });

    statsDiv.innerHTML = `
      <div class="stat-row"><span>Total items</span><span>${closet.length}</span></div>
      <div class="stat-row"><span>Tops</span><span>${counts.Top}</span></div>
      <div class="stat-row"><span>Bottoms</span><span>${counts.Bottom}</span></div>
      <div class="stat-row"><span>Shoes</span><span>${counts.Shoes}</span></div>
      <div class="stat-row"><span>Jackets</span><span>${counts.Jacket}</span></div>
      <div class="stat-row"><span>Dresses</span><span>${counts.Dress}</span></div>
      <div class="stat-row"><span>Saved outfits</span><span>${outfits.length}</span></div>
      <div class="stat-row"><span>Most used color</span><span>${favColor || "â€”"}</span></div>
    `;
  }

  // INIT
  (function init() {
    applyTheme();

    users = loadUsers();
    currentUserId = localStorage.getItem(CURRENT_USER_KEY);
    currentUser = users.find(u => u.id == currentUserId);

    if (!currentUser) {
      window.location.href = "index.html";
      return;
    }

    document.getElementById("userNameLabel").textContent = currentUser.name || "User";

    currentUser.closet = currentUser.closet || [];
    currentUser.outfits = currentUser.outfits || [];

    setupDropzone();
    renderCloset();
    renderBuilder();
    renderSavedOutfits();
    renderStats();
  })();
</script>

</body>
</html>
